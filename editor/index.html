<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menuva v5 JSON Builder</title>
    <!-- Load Ajv for JSON Schema Validation -->
    <script src="https://unpkg.com/ajv@8.12.0/dist/ajv.min.js"></script>
    <script src="https://unpkg.com/ajv-formats@2.1.1/dist/ajv-formats.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        #app { display: flex; flex: 1; overflow: hidden; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; }
        aside { width: 260px; background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* Typography & Components */
        h1 { font-size: 1.25rem; font-weight: 700; margin: 0; color: var(--primary); }
        h2 { font-size: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        h3 { font-size: 1.1rem; margin: 1.5rem 0 1rem; color: var(--text); font-weight: 600; }
        
        .btn { padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: white; font-size: 0.875rem; transition: all 0.2s; }
        .btn:hover { background: var(--bg); }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { color: var(--danger); border-color: var(--danger); }
        .btn-danger:hover { background: #fef2f2; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        .card { background: var(--surface); border-radius: 8px; border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Form Elements */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .form-group .helper { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea {
            width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem;
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .input-error { border-color: var(--danger) !important; }
        .error-msg { color: var(--danger); font-size: 0.75rem; margin-top: 0.25rem; display: block; }

        /* Navigation */
        .nav-item { padding: 0.75rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; color: var(--text-light); }
        .nav-item:hover { background: var(--bg); color: var(--text); }
        .nav-item.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); font-weight: 500; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-valid { background: var(--success); }
        .status-error { background: var(--danger); }
        .status-empty { background: var(--border); }

        /* Tables & Lists */
        .data-list { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .data-item { padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface); }
        .data-item:last-child { border-bottom: none; }
        .data-item:hover { background: #f9fafb; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #e5e7eb; font-size: 0.75rem; margin-right: 4px; }

        /* Complex Editors */
        .lang-map-editor { background: #f9fafb; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border); }
        .lang-row { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .lang-label { width: 60px; font-size: 0.75rem; font-weight: bold; color: var(--text-light); }
        
        .array-toolbar { display: flex; justify-content: flex-end; margin-bottom: 0.5rem; gap: 0.5rem; }
        
        /* JSON Preview */
        pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 6px; overflow: auto; font-size: 0.85rem; max-height: 600px; }
        
        /* Validation Summary in Header */
        .validation-summary { font-size: 0.85rem; margin-right: 1rem; }
        .val-badge { padding: 2px 8px; border-radius: 12px; font-weight: 600; }
        .val-success { background: #d1fae5; color: #065f46; }
        .val-fail { background: #fee2e2; color: #991b1b; }

        /* Utility */
        .flex-row { display: flex; gap: 1rem; }
        .flex-1 { flex: 1; }
        .hidden { display: none; }
        .mt-4 { margin-top: 1rem; }
        .text-sm { font-size: 0.875rem; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <h1>Menuva Builder v5</h1>
    </div>
    <div style="display:flex; align-items:center;">
        <div id="headerValidation" class="validation-summary"></div>
        <button class="btn" onclick="app.newFile()">New</button>
        <button class="btn" style="margin-left: 0.5rem;" onclick="document.getElementById('fileImport').click()">Import JSON</button>
        <input type="file" id="fileImport" accept=".json" style="display:none" onchange="app.importFile(this)">
        <button class="btn btn-primary" style="margin-left: 0.5rem;" onclick="app.nav('preview')">Preview & Export</button>
    </div>
</header>

<div id="app">
    <aside id="sidebar">
        <!-- Generated by JS -->
    </aside>

    <main id="mainContent">
        <!-- Rendered by JS -->
    </main>
</div>

<script>
// ==========================================
// 1. CONSTANTS & SCHEMA
// ==========================================

const SECTIONS = [
    { id: 'basics', label: 'File Basics' },
    { id: 'brand', label: 'Brand & Metadata' },
    { id: 'registries', label: 'Registries' },
    { id: 'locations', label: 'Locations' },
    { id: 'calendars', label: 'Service Calendars' },
    { id: 'sections', label: 'Sections (Categories)' },
    { id: 'items', label: 'Items' },
    { id: 'menus', label: 'Menus' },
    { id: 'promotions', label: 'Promotions' },
    { id: 'fees', label: 'Fees & Provenance' },
    { id: 'preview', label: 'JSON Preview & Export' }
];

const DEFAULT_DATA = {
    schemaVersion: 5,
    id: "new_brand",
    country_code: "GB",
    slug: "new-brand",
    currency: "GBP",
    timezone: "Europe/London",
    languages: ["en-GB"],
    fallbackLanguage: "en-GB",
    items: [],
    sections: [],
    serviceCalendars: [],
    locations: [],
    menus: [],
    promotions: [],
    fees: [],
    provenance: [],
    paymentMethods: ["card", "cash"]
};

// Full V3 Schema (Minified for single-file constraints but functionally complete)
const MENUVA_SCHEMA = {
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://menuva.example/schema/v5.json",
  "type": "object",
  "required": ["schemaVersion", "id", "country_code", "slug", "currency", "timezone", "languages", "fallbackLanguage", "items"],
  "properties": {
    "schemaVersion": { "type": "integer", "minimum": 1 },
    "id": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]{1,32}$" },
    "country_code": { "type": "string", "pattern": "^[A-Z]{2}$" },
    "slug": { "type": "string", "pattern": "^[a-z0-9]+(?:[\\-_][a-z0-9]+)*$" },
    "languages": { "type": "array", "items": { "type": "string", "pattern": "^[A-Za-z]{2,3}(?:-[A-Za-z0-9]{2,8})*$" }, "minItems": 1 },
    "fallbackLanguage": { "type": "string" },
    "currency": { "type": "string", "pattern": "^[A-Z]{3}$" },
    "timezone": { "type": "string" },
    "items": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/item" } },
    "sections": { "type": "array", "items": { "$ref": "#/$defs/section" } },
    "locations": { "type": "array", "items": { "$ref": "#/$defs/location" } },
    "serviceCalendars": { "type": "array", "items": { "$ref": "#/$defs/serviceCalendar" } },
    "menus": { "type": "array", "items": { "$ref": "#/$defs/menu" } },
    "promotions": { "type": "array", "items": { "$ref": "#/$defs/promotion" } },
    "fees": { "type": "array", "items": { "$ref": "#/$defs/fee" } },
    "provenance": { "type": "array", "items": { "$ref": "#/$defs/provenance" } },
    "paymentMethods": { "type": "array", "items": { "$ref": "#/$defs/paymentMethod" } },
    "name": { "$ref": "#/$defs/langString" },
    "description": { "$ref": "#/$defs/langString" },
    "headerImage": { "$ref": "#/$defs/image" },
    "validFrom": { "format": "date" },
    "validUntil": { "format": "date" }
  },
  "$defs": {
    "langString": { "type": "object", "patternProperties": { "^[A-Za-z]{2,3}(?:-[A-Za-z0-9]{2,8})*$": { "type": "string", "minLength": 1 } } },
    "image": { "type": "object", "required": ["name", "alt"], "properties": { "name": {"type":"string"}, "alt": {"$ref":"#/$defs/langString"}, "variants": { "type": "array", "items": { "type": "object", "required":["w","h"], "properties": {"w":{"type":"integer"}, "h":{"type":"integer"}, "suffix":{"type":"string"}} } } } },
    "paymentMethod": { "enum": ["cash", "card", "contactless", "mobileWallet", "online", "voucher", "other"] },
    "item": { 
        "type": "object", "required": ["id", "name"], 
        "properties": { 
            "id": {"type":"string"}, "name": {"$ref":"#/$defs/langString"}, "description": {"$ref":"#/$defs/langString"},
            "price": { "type": "object", "required": ["amountMinor"], "properties": { "amountMinor": { "type": "integer", "minimum": 0 }, "includesTax": {"type":"boolean"}, "taxCode": {"type":"string"} } },
            "categoryId": {"type":"string"}, "calendarId": {"type":"string"}, "image": {"$ref":"#/$defs/image"},
            "customizations": { "type": "array", "items": { "$ref": "#/$defs/customizationGroup" } },
            "bundles": { "type": "array", "items": { "type": "object", "required": ["itemId", "quantity"], "properties": { "itemId": {"type":"string"}, "quantity": {"type":"integer"} } } }
        }
    },
    "section": { "type": "object", "required": ["id", "name"], "properties": { "id": {"type":"string"}, "name": {"$ref":"#/$defs/langString"}, "parentId": {"type":"string"}, "order": {"type":"integer"} } },
    "location": { "type": "object", "required": ["id", "name", "address"], "properties": { "id": {"type":"string"}, "name": {"$ref":"#/$defs/langString"}, "openingCalendarId": {"type":"string"}, "address": {"type":"object", "required":["line1","city"], "properties": {"line1":{"type":"string"},"city":{"type":"string"},"postalCode":{"type":"string"},"country_code":{"type":"string"}} } } },
    "serviceCalendar": { "type": "object", "required": ["id", "name", "windows"], "properties": { "id": {"type":"string"}, "name": {"$ref":"#/$defs/langString"}, "windows": {"type":"array", "items": {"type":"object", "required":["from","until"], "properties": {"from":{"type":"string"}, "until":{"type":"string"}, "days": {"type":"array"}, "exceptDays":{"type":"array"}}}} } },
    "menu": { "type": "object", "required": ["id", "name"], "properties": { "id": {"type":"string"}, "name": {"$ref":"#/$defs/langString"}, "sectionIds": {"type":"array"}, "itemIds": {"type":"array"}, "locationIds": {"type":"array"}, "calendarId": {"type":"string"} } },
    "promotion": { "type": "object", "required": ["id", "name", "type", "discount"], "properties": { "id": {"type":"string"}, "name": {"$ref":"#/$defs/langString"}, "type": {"enum": ["buyXGetY", "buyXGetYPercentOff", "comboDiscount", "categorySpendGetDiscount"]}, "discount": {"type":"object", "required":["type"], "properties": {"type": {"enum":["fixed","percent"]}, "amountMinor": {"type":"integer"}, "percent": {"type":"number"}}} } },
    "fee": { "type": "object", "required": ["type", "amountMinor"], "properties": { "type": {"enum":["bottleDeposit","serviceCharge","containerDeposit","other"]}, "amountMinor": {"type":"integer"}, "label": {"$ref":"#/$defs/langString"} } },
    "provenance": { "type": "object", "required": ["fieldPath", "method", "confidence"], "properties": { "fieldPath": {"type":"string"}, "method": {"enum":["human","ai","import"]}, "confidence": {"type":"number"} } },
    "customizationGroup": { "type": "object", "required": ["order", "key", "title", "type", "required", "options"], "properties": { "order": {"type":"integer"}, "key": {"type":"string"}, "title": {"$ref":"#/$defs/langString"}, "type": {"enum":["single","multi"]}, "required": {"type":"boolean"}, "options": { "type": "array", "items": { "type":"object", "required":["label"], "properties": { "label": {"$ref":"#/$defs/langString"}, "priceDeltaMinor": {"type":"integer"} } } } } }
  }
};

// ==========================================
// 2. CORE APP STATE & LOGIC
// ==========================================

const app = {
    data: null,
    currentView: 'basics',
    validationResult: { valid: true, errors: [] },
    validator: null,

    init() {
        // Load persistence
        const saved = localStorage.getItem('menuva_v5_draft');
        if (saved) {
            try {
                this.data = JSON.parse(saved);
            } catch (e) {
                this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
            }
        } else {
            this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
        }

        // Init Validator
        if (window.Ajv) {
            const ajv = new Ajv({ allErrors: true, strict: false });
            ajv.addFormat('date', /^\d{4}-\d{2}-\d{2}$/);
            this.validator = ajv.compile(MENUVA_SCHEMA);
        }

        this.validate();
        this.renderSidebar();
        this.renderMain();
    },

    save() {
        localStorage.setItem('menuva_v5_draft', JSON.stringify(this.data));
        this.validate();
        this.renderSidebar(); // Update status indicators
    },

    newFile() {
        if (confirm("Are you sure? Unsaved changes will be lost.")) {
            this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
            this.currentView = 'basics';
            this.save();
            this.renderMain();
        }
    },

    importFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Basic migration/safety check
                if (!json.items) json.items = [];
                if (!json.languages) json.languages = ["en"];
                this.data = json;
                this.save();
                this.renderMain();
                alert("Import successful!");
            } catch (err) {
                alert("Invalid JSON file.");
            }
        };
        reader.readAsText(file);
    },

    nav(viewId) {
        this.currentView = viewId;
        this.renderMain();
        this.renderSidebar();
    },

    update(path, value) {
        // Deep update helper
        const keys = path.split('.');
        let obj = this.data;
        for (let i = 0; i < keys.length - 1; i++) {
            // Handle array indices in path like items[0]
            if (keys[i].includes('[')) {
                const [k, idx] = keys[i].split('[');
                const cleanIdx = parseInt(idx.replace(']', ''));
                obj = obj[k][cleanIdx];
            } else {
                if (!obj[keys[i]]) obj[keys[i]] = {};
                obj = obj[keys[i]];
            }
        }
        const lastKey = keys[keys.length - 1];
        if (lastKey.includes('[')) {
             const [k, idx] = lastKey.split('[');
             const cleanIdx = parseInt(idx.replace(']', ''));
             obj[k][cleanIdx] = value;
        } else {
            obj[lastKey] = value;
        }
        this.save();
    },

    // ==========================================
    // 3. VALIDATION LOGIC
    // ==========================================

    validate() {
        const errors = [];
        
        // A) Schema Validation
        if (this.validator) {
            const valid = this.validator(this.data);
            if (!valid) {
                this.validator.errors.forEach(e => {
                    errors.push({ type: 'schema', msg: `${e.instancePath} ${e.message}`, path: e.instancePath });
                });
            }
        }

        // B) Semantic Validation (Guidance Rules)
        const d = this.data;
        
        // Languages
        if (!d.languages || d.languages.length === 0) errors.push({ type: 'semantic', msg: "Must have at least one language." });
        if (d.languages && !d.languages.includes(d.fallbackLanguage)) errors.push({ type: 'semantic', msg: "Fallback language must be in languages array." });

        // Referential Integrity Helpers
        const sectionIds = (d.sections || []).map(s => s.id);
        const calendarIds = (d.serviceCalendars || []).map(c => c.id);
        const locationIds = (d.locations || []).map(l => l.id);
        const itemIds = (d.items || []).map(i => i.id);

        // Check Items
        (d.items || []).forEach((item, idx) => {
            if (item.categoryId && !sectionIds.includes(item.categoryId)) {
                errors.push({ type: 'semantic', msg: `Item '${item.id || idx}': categoryId '${item.categoryId}' not found.` });
            }
            if (item.calendarId && !calendarIds.includes(item.calendarId)) {
                errors.push({ type: 'semantic', msg: `Item '${item.id || idx}': calendarId '${item.calendarId}' not found.` });
            }
            if (item.image && item.image.variants) {
                item.image.variants.forEach(v => {
                    if (v.w !== v.h) errors.push({ type: 'semantic', msg: `Item '${item.id}' image variant must be square.` });
                });
            }
            // Spice Percent
            if (item.spicePercent !== undefined && ![0, 20, 40, 60, 80, 100].includes(item.spicePercent)) {
                 errors.push({ type: 'semantic', msg: `Item '${item.id}' spicePercent must be 0, 20, 40, 60, 80 or 100.` });
            }
        });

        // Check Locations
        (d.locations || []).forEach((loc, idx) => {
            if (loc.openingCalendarId && !calendarIds.includes(loc.openingCalendarId)) {
                errors.push({ type: 'semantic', msg: `Location '${loc.id}': openingCalendarId not found.` });
            }
        });

        // Check Menus
        (d.menus || []).forEach((menu, idx) => {
            if (menu.calendarId && !calendarIds.includes(menu.calendarId)) errors.push({ type: 'semantic', msg: `Menu '${menu.id}': calendarId not found.` });
            (menu.locationIds || []).forEach(lid => {
                if (!locationIds.includes(lid)) errors.push({ type: 'semantic', msg: `Menu '${menu.id}': locationId '${lid}' not found.` });
            });
            (menu.itemIds || []).forEach(iid => {
                if (!itemIds.includes(iid)) errors.push({ type: 'semantic', msg: `Menu '${menu.id}': itemId '${iid}' not found.` });
            });
        });

        this.validationResult = { valid: errors.length === 0, errors };
        
        // Update Header
        const el = document.getElementById('headerValidation');
        if (this.validationResult.valid) {
            el.innerHTML = `<span class="val-badge val-success">Valid ✓</span>`;
        } else {
            el.innerHTML = `<span class="val-badge val-fail">${errors.length} Issues</span>`;
        }
    },

    // ==========================================
    // 4. RENDERING UI
    // ==========================================

    renderSidebar() {
        const el = document.getElementById('sidebar');
        el.innerHTML = SECTIONS.map(section => {
            // Check for errors in this section (approximate mapping)
            let statusClass = 'status-valid';
            if (section.id === 'items' && this.validationResult.errors.some(e => e.msg.includes('items'))) statusClass = 'status-error';
            if (section.id === 'locations' && this.validationResult.errors.some(e => e.msg.includes('Location'))) statusClass = 'status-error';
            // Simple mapping for demo purposes
            
            return `
            <div class="nav-item ${this.currentView === section.id ? 'active' : ''}" onclick="app.nav('${section.id}')">
                <span>${section.label}</span>
                <span class="status-indicator ${statusClass}"></span>
            </div>`;
        }).join('');
    },

    renderMain() {
        const el = document.getElementById('mainContent');
        el.innerHTML = '';
        const d = this.data;

        // Render specific view based on currentView
        switch(this.currentView) {
            case 'basics':
                this.renderBasics(el, d);
                break;
            case 'brand':
                this.renderBrand(el, d);
                break;
            case 'registries':
                this.renderRegistries(el, d);
                break;
            case 'locations':
                this.renderLocations(el, d);
                break;
            case 'calendars':
                this.renderCalendars(el, d);
                break;
            case 'sections':
                this.renderSections(el, d);
                break;
            case 'items':
                this.renderItems(el, d);
                break;
            case 'menus':
                this.renderMenus(el, d);
                break;
            case 'promotions':
                this.renderPromotions(el, d);
                break;
            case 'fees':
                this.renderFees(el, d);
                break;
            case 'preview':
                this.renderPreview(el, d);
                break;
        }
    },

    // --- Helpers for HTML Generation ---

    htmlInput(label, path, type='text', val, helper='') {
        return `
        <div class="form-group">
            <label>${label}</label>
            <input type="${type}" value="${val || ''}" onchange="app.update('${path}', this.type === 'number' ? parseFloat(this.value) : this.value)">
            ${helper ? `<div class="helper">${helper}</div>` : ''}
        </div>`;
    },

    htmlLangString(label, path, valObj) {
        const langs = this.data.languages || ['en'];
        let html = `<div class="form-group"><label>${label} (LangString)</label><div class="lang-map-editor">`;
        langs.forEach(lang => {
            const val = valObj ? (valObj[lang] || '') : '';
            // We use a special handler for object updates
            html += `
            <div class="lang-row">
                <div class="lang-label">${lang}</div>
                <input type="text" value="${val}" onchange="app.updateLang('${path}', '${lang}', this.value)">
            </div>`;
        });
        html += `</div></div>`;
        return html;
    },

    updateLang(path, lang, val) {
        // Find object, update key
        const keys = path.split('.');
        let obj = this.data;
        // Traverse to parent of the langString
        for(let i=0; i<keys.length; i++) {
            // Simplified traversal for top level props
             if (keys[i].includes('[')) {
                const [k, idx] = keys[i].split('[');
                const cleanIdx = parseInt(idx.replace(']', ''));
                obj = obj[k][cleanIdx];
            } else {
                if(!obj[keys[i]]) obj[keys[i]] = {};
                obj = obj[keys[i]];
            }
        }
        obj[lang] = val;
        this.save();
    },

    htmlSelect(label, path, val, options) {
        return `
        <div class="form-group">
            <label>${label}</label>
            <select onchange="app.update('${path}', this.value)">
                <option value="">-- Select --</option>
                ${options.map(opt => `<option value="${opt.value}" ${val === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
            </select>
        </div>`;
    },

    // --- SECTION RENDERERS ---

    renderBasics(el, d) {
        el.innerHTML = `
            <h2>File Basics</h2>
            <div class="card">
                <div class="flex-row">
                    <div class="flex-1">${this.htmlInput('Schema Version', 'schemaVersion', 'number', d.schemaVersion)}</div>
                    <div class="flex-1">${this.htmlInput('File ID', 'id', 'text', d.id)}</div>
                </div>
                <div class="flex-row">
                    <div class="flex-1">${this.htmlInput('Country Code (ISO)', 'country_code', 'text', d.country_code)}</div>
                    <div class="flex-1">${this.htmlInput('Currency', 'currency', 'text', d.currency)}</div>
                </div>
                ${this.htmlInput('Slug', 'slug', 'text', d.slug, 'URL-friendly identifier')}
                ${this.htmlInput('Timezone', 'timezone', 'text', d.timezone, 'e.g. Europe/London')}
            </div>
            
            <h3>Languages</h3>
            <div class="card">
                <div class="form-group">
                    <label>Supported Languages (BCP-47)</label>
                    <input type="text" value="${d.languages.join(',')}" onchange="app.update('languages', this.value.split(',').map(s=>s.trim()).filter(s=>s))">
                    <div class="helper">Comma separated, e.g. en-GB, fr-FR</div>
                </div>
                ${this.htmlSelect('Fallback Language', 'fallbackLanguage', d.fallbackLanguage, d.languages.map(l=>({value:l, label:l})))}
            </div>
        `;
    },

    renderBrand(el, d) {
        el.innerHTML = `
            <h2>Brand & Metadata</h2>
            <div class="card">
                ${this.htmlInput('Internal Name', 'friendly_name', 'text', d.friendly_name)}
                ${this.htmlLangString('Brand Name (Public)', 'name', d.name)}
                ${this.htmlLangString('Description', 'description', d.description)}
                ${this.htmlInput('Restaurant Category', 'restaurantCategory', 'text', d.restaurantCategory)}
            </div>
            <h3>Metadata</h3>
            <div class="card">
                <div class="flex-row">
                    <div class="flex-1">${this.htmlInput('Valid From', 'validFrom', 'date', d.validFrom)}</div>
                    <div class="flex-1">${this.htmlInput('Valid Until', 'validUntil', 'date', d.validUntil)}</div>
                </div>
            </div>
        `;
    },

    renderRegistries(el, d) {
        if (!d.registries) d.registries = {};
        el.innerHTML = `
            <h2>Registries</h2>
            <div class="card">
                ${this.htmlInput('Allergen Registry URN', 'registries.allergens', 'text', d.registries.allergens)}
                ${this.htmlInput('Dietary Registry URN', 'registries.dietary', 'text', d.registries.dietary)}
            </div>
        `;
    },

    renderLocations(el, d) {
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Locations</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('locations')">Add Location</button>
            </div>
            <div class="data-list">
                ${d.locations.map((loc, idx) => `
                    <div class="data-item">
                        <div>
                            <strong>${loc.id || 'New Location'}</strong>
                            <div class="text-sm">${(loc.name && loc.name[d.fallbackLanguage]) || 'No Name'}</div>
                        </div>
                        <button class="btn btn-sm" onclick="app.editItem('locations', ${idx})">Edit</button>
                    </div>
                `).join('')}
            </div>
        `;
    },

    renderCalendars(el, d) {
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Service Calendars</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('serviceCalendars')">Add Calendar</button>
            </div>
            <div class="data-list">
                ${d.serviceCalendars.map((cal, idx) => `
                    <div class="data-item">
                        <div>
                            <strong>${cal.id || 'New ID'}</strong>
                            <div class="text-sm">${(cal.name && cal.name[d.fallbackLanguage]) || 'No Name'}</div>
                        </div>
                        <button class="btn btn-sm" onclick="app.editItem('serviceCalendars', ${idx})">Edit</button>
                    </div>
                `).join('')}
            </div>
        `;
    },

    renderSections(el, d) {
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Sections (Categories)</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('sections')">Add Section</button>
            </div>
            <div class="data-list">
                ${d.sections.map((sec, idx) => `
                    <div class="data-item">
                        <div>
                            <strong>${sec.id || 'new_section'}</strong> 
                            <span class="text-sm text-light">Order: ${sec.order || '-'}</span>
                            <div class="text-sm">${(sec.name && sec.name[d.fallbackLanguage]) || 'No Name'}</div>
                        </div>
                        <div>
                            ${sec.parentId ? '<span class="tag">Subcategory</span>' : '<span class="tag">Root</span>'}
                            <button class="btn btn-sm" onclick="app.editItem('sections', ${idx})">Edit</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    },

    renderItems(el, d) {
        // Filter logic could go here
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Items</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('items')">Add Item</button>
            </div>
            <div class="data-list">
                ${d.items.map((item, idx) => `
                    <div class="data-item">
                        <div style="flex:1">
                            <div style="display:flex; justify-content:space-between; width:100%">
                                <strong>${(item.name && item.name[d.fallbackLanguage]) || 'New Item'}</strong>
                                <span class="text-sm">${item.price ? (item.price.amountMinor/100).toFixed(2) : '-'}</span>
                            </div>
                            <div class="text-sm text-light">ID: ${item.id} | Cat: ${item.categoryId || '-'}</div>
                        </div>
                        <button class="btn btn-sm" style="margin-left:10px;" onclick="app.editItem('items', ${idx})">Edit</button>
                    </div>
                `).join('')}
            </div>
        `;
    },

    renderMenus(el, d) {
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Menus</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('menus')">Add Menu</button>
            </div>
            <div class="data-list">
                ${d.menus.map((m, idx) => `
                    <div class="data-item">
                        <div>
                            <strong>${(m.name && m.name[d.fallbackLanguage]) || m.id}</strong>
                            <div class="text-sm text-light">Valid: ${m.validFrom || 'Any'} - ${m.validUntil || 'Any'}</div>
                        </div>
                        <button class="btn btn-sm" onclick="app.editItem('menus', ${idx})">Edit</button>
                    </div>
                `).join('')}
            </div>
        `;
    },

    renderPromotions(el, d) {
         el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Promotions</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('promotions')">Add Promotion</button>
            </div>
            <div class="data-list">
                ${d.promotions.map((p, idx) => `
                    <div class="data-item">
                        <div>
                            <strong>${(p.name && p.name[d.fallbackLanguage]) || p.id}</strong>
                            <div class="text-sm text-light">${p.type}</div>
                        </div>
                        <button class="btn btn-sm" onclick="app.editItem('promotions', ${idx})">Edit</button>
                    </div>
                `).join('')}
            </div>
        `;
    },

    renderFees(el, d) {
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h2>Fees & Provenance</h2>
                <button class="btn btn-primary btn-sm" onclick="app.addItem('fees')">Add Fee</button>
            </div>
            <div class="data-list" style="margin-bottom:2rem;">
                ${d.fees.map((f, idx) => `
                    <div class="data-item">
                        <div>${f.type} - ${(f.amountMinor/100).toFixed(2)}</div>
                        <button class="btn btn-sm btn-danger" onclick="app.deleteItem('fees', ${idx})">Delete</button>
                    </div>
                `).join('')}
            </div>
            <h3>Provenance</h3>
            <textarea style="height:200px" onchange="try{app.data.provenance = JSON.parse(this.value); app.save();}catch(e){alert('Invalid JSON')}">${JSON.stringify(d.provenance, null, 2)}</textarea>
            <div class="helper">Edit Raw JSON for provenance</div>
        `;
    },

    renderPreview(el, d) {
        const jsonStr = JSON.stringify(d, null, 2);
        el.innerHTML = `
            <h2>JSON Preview & Export</h2>
            <div class="flex-row" style="margin-bottom:1rem;">
                <button class="btn" onclick="navigator.clipboard.writeText(JSON.stringify(app.data,null,2)); alert('Copied!')">Copy to Clipboard</button>
                <button class="btn" onclick="app.downloadJSON()">Download .json</button>
            </div>
            <pre>${jsonStr}</pre>
        `;
    },

    // ==========================================
    // 5. GENERIC LIST/MODAL HANDLERS
    // ==========================================

    addItem(collection) {
        let newItem = { id: `new_${collection}_${Date.now()}` };
        // Defaults based on type
        if (collection === 'locations') newItem = { id: `loc_${Date.now()}`, name: {}, address: { line1: "", city: "" } };
        if (collection === 'serviceCalendars') newItem = { id: `cal_${Date.now()}`, name: {}, windows: [{from:"09:00", until:"17:00", days:["Mon","Tue","Wed","Thu","Fri"]}] };
        if (collection === 'sections') newItem = { id: `sec_${Date.now()}`, name: {} };
        if (collection === 'items') newItem = { id: `item_${Date.now()}`, name: {}, price: { amountMinor: 0, includesTax: true } };
        if (collection === 'menus') newItem = { id: `menu_${Date.now()}`, name: {} };
        if (collection === 'promotions') newItem = { id: `promo_${Date.now()}`, name: {}, type: "buyXGetY", discount: { type: "percent", percent: 10 } };
        if (collection === 'fees') newItem = { type: 'serviceCharge', amountMinor: 0 };

        if (!this.data[collection]) this.data[collection] = [];
        this.data[collection].push(newItem);
        this.save();
        this.renderMain(); // Refresh list
        // Immediately edit new item
        this.editItem(collection, this.data[collection].length - 1);
    },

    deleteItem(collection, index) {
        if(confirm('Delete this item?')) {
            this.data[collection].splice(index, 1);
            this.save();
            this.renderMain();
        }
    },

    // This is a simplified "Master Editor" that renders a form for any object
    // For a real production app, this would be broken into distinct components
    editItem(collection, index) {
        const item = this.data[collection][index];
        const el = document.getElementById('mainContent');
        const basePath = `${collection}[${index}]`;

        let content = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <button class="btn" onclick="app.renderMain()">← Back to List</button>
                <button class="btn btn-danger" onclick="app.deleteItem('${collection}', ${index})">Delete Item</button>
            </div>
            <div class="card">
        `;

        if (collection === 'locations') {
            content += `
                <h3>Location Details</h3>
                ${this.htmlInput('ID', `${basePath}.id`, 'text', item.id)}
                ${this.htmlLangString('Name', `${basePath}.name`, item.name)}
                ${this.htmlInput('Line 1', `${basePath}.address.line1`, 'text', item.address?.line1)}
                ${this.htmlInput('City', `${basePath}.address.city`, 'text', item.address?.city)}
                ${this.htmlInput('Postcode', `${basePath}.address.postalCode`, 'text', item.address?.postalCode)}
                ${this.htmlSelect('Opening Calendar', `${basePath}.openingCalendarId`, item.openingCalendarId, this.data.serviceCalendars.map(c=>({value:c.id, label:c.id})))}
            `;
        } else if (collection === 'items') {
            content += `
                <h3>Item Core</h3>
                ${this.htmlInput('ID', `${basePath}.id`, 'text', item.id)}
                ${this.htmlLangString('Name', `${basePath}.name`, item.name)}
                ${this.htmlLangString('Description', `${basePath}.description`, item.description)}
                ${this.htmlSelect('Category', `${basePath}.categoryId`, item.categoryId, this.data.sections.map(s=>({value:s.id, label:s.id})))}
                
                <h3>Pricing</h3>
                ${this.htmlInput('Price (Minor Units)', `${basePath}.price.amountMinor`, 'number', item.price?.amountMinor)}
                ${this.htmlInput('Tax Code', `${basePath}.price.taxCode`, 'text', item.price?.taxCode)}
                
                <h3>Properties</h3>
                ${this.htmlSelect('Spice %', `${basePath}.spicePercent`, item.spicePercent, [0,20,40,60,80,100].map(n=>({value:n, label:n})))}
                <div class="form-group"><label>Nutrition (JSON)</label><textarea style="height:100px" onchange="app.update('${basePath}.nutrition', JSON.parse(this.value))">${JSON.stringify(item.nutrition || {},null,2)}</textarea></div>
                
                <h3>Customizations (JSON)</h3>
                <textarea style="height:150px" onchange="app.update('${basePath}.customizations', JSON.parse(this.value))">${JSON.stringify(item.customizations || [],null,2)}</textarea>
                <div class="helper">Use raw JSON for complex nested customization arrays for now.</div>
            `;
        } else if (collection === 'serviceCalendars') {
             content += `
                ${this.htmlInput('ID', `${basePath}.id`, 'text', item.id)}
                ${this.htmlLangString('Name', `${basePath}.name`, item.name)}
                <h3>Windows (Raw JSON)</h3>
                <textarea style="height:200px" onchange="app.update('${basePath}.windows', JSON.parse(this.value))">${JSON.stringify(item.windows, null, 2)}</textarea>
             `;
        } else if (collection === 'sections') {
             content += `
                ${this.htmlInput('ID', `${basePath}.id`, 'text', item.id)}
                ${this.htmlLangString('Name', `${basePath}.name`, item.name)}
                ${this.htmlSelect('Parent Section', `${basePath}.parentId`, item.parentId, this.data.sections.filter(s=>s.id !== item.id).map(s=>({value:s.id, label:s.id})))}
                ${this.htmlInput('Order', `${basePath}.order`, 'number', item.order)}
             `;
        } else {
            // Generic Fallback Editor
            content += `
                ${this.htmlInput('ID', `${basePath}.id`, 'text', item.id)}
                ${this.htmlLangString('Name', `${basePath}.name`, item.name)}
                <h3>Raw JSON Data</h3>
                <textarea style="height:400px" onchange="try{app.update('${basePath}', JSON.parse(this.value));}catch(e){alert('Invalid JSON')}">${JSON.stringify(item, null, 2)}</textarea>
            `;
        }

        content += `</div>`;
        el.innerHTML = content;
    },

    downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `menuva_${this.data.id}_v5.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
};

// Start App
app.init();

</script>
</body>
</html>
